# Make a backup of databases inside a container

Assuming a typical container configuration, we'll gather a list of all available databases inside the container and then save a copy of each one in `/srv/db`. Backups get rotated as they are made.

**Preparation**
* `/srv/db` should be present regardless. An empty directory signals that database backups were run at some point and either failed or no databases were found.
* Delete any previous backups that are more than a week old *if* there is at least one backup that's less than a week old.
    * This isn't perfect; if a backup only runs successfully every N > 7 days, then old backups never get deleted. Still, it's safer than accidentally nuking the last good copy of a database.
```bash
mkdir -p /srv/db
if [ "$(find /srv/db/ -name "*.tar.gz" -type f -mtime -7 | wc -l)" -gt 1 ]; then
   find /srv/db/ -name "*.tar.gz" -type f -mtime +7 -delete
fi
```


**MySQL**
* If MySQL is not installed *or* there are no user databases present, then nothing needs to be done.
* If MySQL *is* installed, then let's install `mydumper` also (for more efficient exports), and then use that to export each database.
* The list of databases to export is generated by examining MySQL's `INFORMATION_SCHEMA` table.
```bash
if command -v mysql >/dev/null; then
    command -v mydumper >/dev/null || apt-get -y install mydumper >/dev/null 2>&1
    timestamp="$(date +'%Y%m%d-%H%M%S')"
    for db in $(/usr/bin/mysql -NB -e 'SELECT SCHEMA_NAME AS db FROM INFORMATION_SCHEMA.SCHEMATA WHERE SCHEMA_NAME NOT IN("mysql", "information_schema", "performance_schema");'); do
        mkdir -p "/srv/db/$db/$timestamp"
        /usr/bin/mydumper -EGRNe -o "/srv/db/$db/$timestamp" -B "$db"
        tar --remove-files -czvf "/srv/db/$db/$timestamp.sql.tar.gz" "/srv/db/$db/$timestamp"
    done
fi
```


**Cleanup**
Remove any 0-length files or directories under `/srv/db`.
```bash
find /srv/db/ -size 0 -delete
```